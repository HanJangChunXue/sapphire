<!-- 
 ******************************************************************************
 * Copyright (c) 2014 Oracle
 * All rights reserved. This program and the accompanying materials
 * are made available under the terms of the Eclipse Public License v1.0
 * which accompanies this distribution, and is available at
 * http://www.eclipse.org/legal/epl-v10.html
 *
 * Contributors:
 *    Konstantin Komissarchik - initial implementation and ongoing maintenance
 ******************************************************************************
-->

<project name="sapphire" default="build">


  <!--
    *************************************************************************************************
    * Initialization                                                                                *
    *************************************************************************************************
  -->

  <property environment="env"/>
  
  <import file="releng/ant-library/library.xml"/>
  
  <property name="Signing.Library" value="sign-local.xml"/>
  <import file="${Signing.Library}"/>
  
  <echo message="Java Version: ${java.version}"/>


  <target name="init" depends="init-library,init-jdk-16">

    <dirname property="root.dir" file="${ant.file.sapphire}"/>
    <property name="releng.dir" value="${root.dir}/releng"/>
    <property name="build.dir" value="${root.dir}/build"/>

    <property file="build.properties"/>
    <property file="${releng.dir}/installables.properties"/>

  </target>


  <target name="init-bootstrap-platform" depends="init">

    <property name="bootstrap.platform" value="${build.dir}/bootstrap"/>

    <if>
      <not><available file="${bootstrap.platform}"/></not>
      <then>
        <install-eclipse dest="${bootstrap.platform}"/>
      </then>
    </if>

  </target>



  <!--
    *************************************************************************************************
    * Repository Build                                                                              *
    *************************************************************************************************
  -->

  <target name="build-repository" depends="init,init-bootstrap-platform">
    <build-repository/>
  </target>


  <macrodef name="build-repository">
    <sequential>

      <if>
        <not><isset property="build.repository.completed"/></not>
        <then>
          <if>
            <available file="${build.dir}/repository"/>
            <then>
              <echo message="Found existing Sapphire repository..."/>
              <var name="build.repository.completed" value="true"/>
              <load-build-repository url="file:${build.dir}/repository"/>
            </then>
          </if>
        </then>
      </if>

      <if>
        <not><isset property="build.repository.completed"/></not>
        <then>

          <delete dir="${build.dir}/repository" quiet="true"/>
          <mkdir dir="${build.dir}/repository"/>

          <!-- Stage 1 -->

          <echo message="Performing source code verification..."/>
            
          <VerifyCopyrightHeaders Source="${root.dir}"/>
          <VerifyAuthorTags Source="${root.dir}"/>

          <!-- Stage 2 -->

          <with-target-platform configuration="${configuration.recommended}">
            <pde-build build.id="${DSTAMP}" feature="org.eclipse.sapphire.everything" eclipse="${.target.platform}" root.dir="${root.dir}" warnings="true"/>
          </with-target-platform>

          <unzip src="${build.dir}/org.eclipse.sapphire.everything-${DSTAMP}.zip" dest="${build.dir}/repository">
            <mapper type="regexp" from="^eclipse/(.*)$$" to="\1"/>
          </unzip>

          <delete file="${build.dir}/org.eclipse.sapphire.everything-${DSTAMP}.zip"/>

          <zip-dirs source.dir="${build.dir}/repository/features" suffix="jar"/>

          <delete>
            <fileset dir="${build.dir}/repository/features" includes="org.eclipse.sapphire.everything_*.jar"/>
          </delete>

          <!-- Stage 3 -->

          <echo message="Setting Require-Bundle version constraints..."/>

          <mkdir dir="${build.dir}/repository/temp"/>

          <expand-all source.dir="${build.dir}/repository/plugins" dest.dir="${build.dir}/repository/temp" suffix="jar">
            <delete file="@{archive.file}"/>
          </expand-all>

          <with-target-platform configuration="${configuration.min}">
            <create-inventory dest="${build.dir}/repository/temp/min-platform-inventory.txt">
              <plugins>
                <pathelement location="${.target.platform}/plugins"/>
              </plugins>
            </create-inventory>
          </with-target-platform>

          <with-target-platform configuration="${configuration.max}">
            <create-inventory dest="${build.dir}/repository/temp/max-platform-inventory.txt">
              <plugins>
                <pathelement location="${.target.platform}/plugins"/>
              </plugins>
            </create-inventory>
          </with-target-platform>

          <set-bundle-version-constraints
            minPlatformInventory="${build.dir}/repository/temp/min-platform-inventory.txt"
            targetPlatformInventory="${build.dir}/repository/temp/max-platform-inventory.txt"
            pluginsDirectory="${build.dir}/repository/temp">
            <exclude id=".*\.source"/>
            <rule bundle="org.junit" expr="[M1.M2.M3,5.0.0)"/>
			<rule bundle="org.objectweb.asm" expr="[4.0.0,6.0.0)"/>
            <rule bundle="org.eclipse.sapphire*" expr="[M1.M2.M3,T1.T2.T3+1)"/>
            <rule bundle="*" expr="[M1.M2.M3,T1+1.0.0)"/>
          </set-bundle-version-constraints>

          <!-- Stage 4 -->

          <echo message="Setting versions of Export-Package entries..."/>

          <set-export-package-version bundles="${build.dir}/repository/temp"/>
            
          <zip-dirs source.dir="${build.dir}/repository/temp" dest.dir="${build.dir}/repository/plugins" suffix="jar"/>

          <delete dir="${build.dir}/repository/temp"/>
            
          <!-- Stage 5 -->
            
          <echo message="Performing repository verification..."/>
            
          <VerifyAboutHtml Repository="${build.dir}/repository"/>

          <!-- Stage 6 -->
            
          <property-from-set property=".sapphire.feature">
            <fileset dir="${build.dir}/repository/features" includes="org.eclipse.sapphire.modeling_*.jar"/>
          </property-from-set>

          <var name="sapphire.version" unset="true"/>
          <propertyregex property="sapphire.version" input="${.sapphire.feature}" regexp=".*_([0-9]*.[0-9]*.[0-9]*.[0-9]*).jar" select="\1"/>
            
          <var name="sapphire.version.no.qualifier" unset="true"/>
          <propertyregex property="sapphire.version.no.qualifier" input="${sapphire.version}" regexp="([0-9]*.[0-9]*.[0-9]*).[0-9]*" select="\1"/>

          <if>
            <istrue value="${sign}"/>
            <then>
               
              <echo message="Signing features and plugins..."/>
                
              <zip destfile="${build.dir}/repository.zip" basedir="${build.dir}/repository"/>
              <delete dir="${build.dir}/repository"/>
            
              <Sign Project="sapphire" Job="${sapphire.version.no.qualifier}" File="${build.dir}/repository.zip" Output="${build.dir}/repository.zip"/>
            
              <unzip src="${build.dir}/repository.zip" dest="${build.dir}/repository"/>
              <delete file="${build.dir}/repository.zip"/>
                
            </then>
          </if>
            
          <!-- Stage 7 -->
            
          <echo message="Mirroring ASM..."/>

          <with-target-platform configuration="${configuration.recommended}">
            <copy todir="${build.dir}/repository/plugins">
              <fileset dir="${.target.platform}/plugins">
                <include name="org.objectweb.asm_5.*.jar"/>
              </fileset>
            </copy>
          </with-target-platform>

          <!-- Stage 8 -->

          <echo message="Packaging the repository..."/>

          <copy file="${releng.dir}/site.xml" tofile="${build.dir}/repository/site.xml"/>

          <replace file="${build.dir}/repository/site.xml">
            <replacefilter token="##version##" value="${sapphire.version}"/>
          </replace>

          <p2.publish.UpdateSite location="${build.dir}/repository"/>

          <delete file="${build.dir}/repository/site.xml"/>

          <load-build-repository url="file:${build.dir}/repository"/>

          <property name="build.repository.completed" value="true"/>

        </then>
        <else>

          <!-- Determine the version of Sapphire in repository. -->

          <property-from-set property=".sapphire.feature">
            <fileset dir="${build.dir}/repository/features" includes="org.eclipse.sapphire.modeling_*.jar"/>
          </property-from-set>

          <var name="sapphire.version" unset="true"/>
          <propertyregex property="sapphire.version" input="${.sapphire.feature}" regexp=".*_([0-9]*.[0-9]*.[0-9]*.[0-9]*).jar" select="\1"/>

        </else>
      </if>

    </sequential>
  </macrodef>
  

  <macrodef name="VerifyCopyrightHeaders">
    <attribute name="Source"/>
    <sequential>
      <var name=".verify.copyright.failed" unset="true"/>
      <for param="file">
        <path>
          <fileset dir="@{Source}/plugins">
            <include name="**/*.java"/>
            <include name="**/*.xml"/>
            <include name="**/*.sdef"/>
            <include name="**/*.jj"/>
            <exclude name="**/.javacc/**"/>
            <exclude name="**/.apt_generated/**"/>
            <exclude name="*/build.xml"/>
          </fileset>
          <fileset dir="@{Source}/features">
            <include name="**/*.xml"/>
            <exclude name="*/build.xml"/>
          </fileset>
        </path>
        <sequential>
          <var name=".file.content" unset="true"/>
          <loadfile property=".file.content" srcfile="@{file}"/>
          <if>
            <not>
              <and>
                <contains string="${.file.content}" substring="copyright" casesensitive="false"/>
                <contains string="${.file.content}" substring="(c)"/>
              </and>
            </not>
            <then>
              <var name=".file.relative" unset="true"/>
              <pathconvert property=".file.relative">
                <path location="@{file}"/>
                <map from="@{Source}\" to=""/>
                <map from="@{Source}/" to=""/>
                <map from="@{Source}" to=""/>
              </pathconvert>
              <echo message="Missing copyright: ${.file.relative}"/>
              <var name=".verify.copyright.failed" value="true"/>
            </then>
          </if>
        </sequential>
      </for>
      <if>
        <istrue value="${.verify.copyright.failed}"/>
        <then>
          <fail message="Found one or more files with missing copyright."/>
        </then>
      </if>
      <var name=".file.content" unset="true"/>
      <var name=".file.relative" unset="true"/>
      <var name=".verify.copyright.failed" unset="true"/>
    </sequential>
  </macrodef>


  <macrodef name="VerifyAuthorTags">
    <attribute name="Source"/>
    <sequential>
      <var name=".verify.author.failed" unset="true"/>
      <for param="file">
        <path>
          <fileset dir="@{Source}/plugins">
            <include name="**/*.java"/>
            <exclude name="**/.javacc/**"/>
            <exclude name="**/.apt_generated/**"/>
          </fileset>
        </path>
        <sequential>
          <var name=".file.content" unset="true"/>
          <loadfile property=".file.content" srcfile="@{file}"/>
          <if>
            <not>
              <contains string="${.file.content}" substring="@author" casesensitive="false"/>
            </not>
            <then>
              <var name=".file.relative" unset="true"/>
              <pathconvert property=".file.relative">
                <path location="@{file}"/>
                <map from="@{Source}\" to=""/>
                <map from="@{Source}/" to=""/>
                <map from="@{Source}" to=""/>
              </pathconvert>
              <echo message="Missing @author tag: ${.file.relative}"/>
              <var name=".verify.author.failed" value="true"/>
            </then>
          </if>
        </sequential>
      </for>
      <if>
        <istrue value="${.verify.author.failed}"/>
        <then>
          <fail message="Found one or more files with missing @author tag."/>
        </then>
      </if>
      <var name=".file.content" unset="true"/>
      <var name=".file.relative" unset="true"/>
      <var name=".verify.author.failed" unset="true"/>
    </sequential>
  </macrodef>
  
  
  <macrodef name="VerifyAboutHtml">
    <attribute name="Repository"/>
    <sequential>
      <var name=".verify.about.html.failures" unset="true"/>
      <for param="file">
        <path>
          <fileset dir="@{Repository}/plugins">
            <include name="org.eclipse.sapphire*.jar"/>
          </fileset>
        </path>
        <sequential>
          <delete dir="${build.dir}/temp" quiet="true"/>
          <mkdir dir="${build.dir}/temp"/>
          <unzip src="@{file}" dest="${build.dir}/temp"/>
          <if>
            <not>
              <available file="${build.dir}/temp/about.html"/>
            </not>
            <then>
              <basename file="@{file}" property=".file.relative"/>
              <if>
                <isset property=".verify.about.html.failures"/>
                <then>
                  <var name=".verify.about.html.failures" value="${.verify.about.html.failures};${.file.relative}"/>
                </then>
                <else>
                  <var name=".verify.about.html.failures" value="${.file.relative}"/>
                </else>
              </if>
              <var name=".file.relative" unset="true"/>
            </then>
          </if>
        </sequential>
      </for>
      <if>
        <isset property=".verify.about.html.failures"/>
        <then>
          <echo message="Bundles missing about.html file:"/>
          <for param="file" list="${.verify.about.html.failures}" delimiter=";">
            <sequential>
              <echo message="   @{file}"/>
            </sequential>
          </for>
          <fail message="Found one or more bundles missing about.html file."/>
        </then>
      </if>
      <var name=".verify.about.html.failures" unset="true"/>
    </sequential>
  </macrodef>



  <!--
    *************************************************************************************************
    * Alternative Configurations Build                                                              *
    *************************************************************************************************
  -->

  <!-- Builds against alternative supported configurations. The list of alternative
       configurations is defined to exclude the recommended configuration, which is covered by the
       build-repository target. The purpose of this target is only to verify clean compilation. As
       such, unlike build-repository target, this target does not perform any of the post-build
       processing or produce consumable binaries. -->

  <target name="build-alt-configurations" unless="build.alt.configurations.completed" depends="init,init-bootstrap-platform,build-repository">

    <for-each-configuration>
      <if>
        <not><equals arg1="${.configuration}" arg2="${configuration.recommended}"/></not>
        <then>

          <echo message="Building Sapphire with ${.configuration} configuration..."/>

          <with-target-platform configuration="${.configuration}">
            <pde-build build.id="${DSTAMP}" feature="org.eclipse.sapphire.everything" eclipse="${.target.platform}" root.dir="${root.dir}"/>
          </with-target-platform>

          <delete file="${build.dir}/org.eclipse.sapphire.stage3-${DSTAMP}.zip"/>

        </then>
      </if>
    </for-each-configuration>

    <property name="build.alt.configurations.completed" value="true"/>

  </target>



  <!--
    *************************************************************************************************
    * Full Build                                                                                    *
    *************************************************************************************************
  -->

  <target name="build" depends="build-repository">

    <delete dir="${build.dir}/packages" quiet="true"/>
    <mkdir dir="${build.dir}/packages"/>

    <zip destfile="${build.dir}/packages/sapphire-repository-${sapphire.version}.zip" filesonly="true">
      <fileset dir="${build.dir}/repository" excludes=".artifactlock/**/*"/>
    </zip>

    <zip destfile="${build.dir}/packages/sapphire-samples-${sapphire.version}.zip">
      <fileset dir="${root.dir}/plugins/org.eclipse.sapphire.samples">
        <exclude name=".apt_generated/**/*"/>
        <exclude name=".resources/**/*"/>
        <exclude name="bin/**/*"/>
      </fileset>
    </zip>

  </target>


  <!--
    *************************************************************************************************
    * Tests                                                                                         *
    *************************************************************************************************
  -->

  <target name="run-tests" depends="build-repository">

    <!-- Get ready to run tests. -->

    <property name="tests.working.dir" value="${build.dir}/tests"/>
    <delete dir="${tests.working.dir}" quiet="true"/>
    <mkdir dir="${tests.working.dir}"/>

    <install-eclipse dest="${tests.working.dir}/install" extensions="${iu.sapphire.tests.install}"/>

    <!-- Run tests. -->

    <eclipse location="${tests.working.dir}/install" application="org.eclipse.test.uitestapplication" failonerror="false" resultproperty="org.eclipse.test.result">
      <arg line="-dev bin"/>
      <arg line="-data ${tests.working.dir}/workspace"/>
      <arg line="formatter=org.apache.tools.ant.taskdefs.optional.junit.XMLJUnitResultFormatter,${tests.working.dir}/test-results.xml"/>
      <arg line="-testPluginName org.eclipse.sapphire.tests"/>
      <arg line="-className org.eclipse.sapphire.tests.SapphireTestSuite"/>
      <arg line="-consolelog -debug"/>
    </eclipse>

    <!-- Collect various test artifacts and copy them to the results directory. -->

    <fail message="JUnit results file not created!">
      <condition>
        <not>
          <available file="${tests.working.dir}/test-results.xml"/>
        </not>
      </condition>
    </fail>

    <junitreport todir="${tests.working.dir}">
      <fileset dir="${tests.working.dir}" includes="test-results.xml"/>
      <report todir="${tests.working.dir}" format="noframes"/>
    </junitreport>

    <delete file="${tests.working.dir}/TESTS-TestSuites.xml"/>
    <move file="${tests.working.dir}/junit-noframes.html" tofile="${tests.working.dir}/test-results.html"/>
    
    <!-- Check if the tests have passed or failed. -->

    <if>
      <equals arg1="${org.eclipse.test.result}" arg2="0"/>
      <then>
        <echo message="All tests have passed."/>
      </then>
      <else>
        <fail message="One or more tests have failed."/>
      </else>
    </if>

  </target>
  
  
  <!--
    *************************************************************************************************
    * FindBugs                                                                                      *
    *************************************************************************************************
  -->

  
  <target name="findbugs" depends="init">
    <findbugs/>
  </target>


  <macrodef name="findbugs">
    <sequential>
      
      <if>
        <not><isset property="findbugs.output"/></not>
        <then>
          <if>
            <available file="${build.dir}/findbugs"/>
            <then>
              <echo message="Found existing findbugs output..."/>
              <var name="findbugs.output" value="${build.dir}/findbugs"/>
            </then>
          </if>
        </then>
      </if>

      <if>
        <not><isset property="findbugs.output"/></not>
        <then>

          <if>
            <and>
              <not><isset property="findbugs.location"/></not>
              <isset property="env.FINDBUGS"/>
            </and>
            <then>
              <var name="findbugs.location" value="${env.FINDBUGS}"/>
            </then>
          </if>

          <if>
            <not><isset property="findbugs.location"/></not>
            <then>
              <fail message="Could not locate FindBugs. Specify either findbugs.location property or FINDBUGS environment variable."/>
            </then>
          </if>

          <build-repository/>

          <property name="findbugs.output" value="${build.dir}/findbugs"/>

          <delete dir="${findbugs.output}" quiet="true"/>
          <mkdir dir="${findbugs.output}"/>

          <taskdef name="findbugs-task" classname="edu.umd.cs.findbugs.anttask.FindBugsTask">
            <classpath>
              <fileset dir="${findbugs.location}/lib">
                <include name="*.jar"/>
              </fileset>
            </classpath>
          </taskdef>

          <with-target-platform configuration="${configuration.recommended}">
            <pathconvert property=".aux.xml" pathsep="&lt;/AuxClasspathEntry&gt;&#xA;&lt;AuxClasspathEntry&gt;">
              <path>
                <fileset dir="${.target.platform}/plugins">
                  <include name="**/*.jar"/>
                </fileset>
              </path>
            </pathconvert>
          </with-target-platform>

          <pathconvert property=".source.xml" pathsep="&lt;/SrcDir&gt;&#xA;&lt;SrcDir&gt;">
            <path>
              <dirset dir="${root.dir}/plugins" includes="*/src"/>
            </path>
          </pathconvert>

          <pathconvert property=".jars.xml" pathsep="&lt;/Jar&gt;&#xA;&lt;Jar&gt;">
            <path>
              <fileset dir="${build.dir}/repository/plugins">
                <include name="org.eclipse.sapphire*.jar"/>
                <exclude name="*.source_*.jar"/>
                <exclude name="*.nl_re_*.jar"/>
              </fileset>
            </path>
          </pathconvert>

          <echo file="${findbugs.output}/project.xml">
            &lt;BugCollection>
              &lt;Project filename="findbugs.project" projectName="Sapphire">
                &lt;Jar&gt;${.jars.xml}&lt;/Jar&gt;
                &lt;AuxClasspathEntry&gt;${.aux.xml}&lt;/AuxClasspathEntry&gt;
                &lt;SrcDir&gt;${.source.xml}&lt;/SrcDir&gt;
                &lt;SuppressionFilter&gt;
                  &lt;LastVersion value="-1" relOp="NEQ"/&gt;
                &lt;/SuppressionFilter&gt;
              &lt;/Project&gt;
            &lt;/BugCollection&gt;
          </echo>

          <var name=".aux.xml" unset="true"/>
          <var name=".source.xml" unset="true"/>
          <var name=".jars.xml" unset="true"/>

          <findbugs-task
            home="${findbugs.location}"
            projectFile="${findbugs.output}/project.xml"
            excludeFilter="${root.dir}/findbugs-excludes.xml"
            output="xml"
            outputFile="${findbugs.output}/result.xml"
            timeout="2400000"
            jvmargs="-Xmx1024m -XX:MaxPermSize=256m"/>

        </then>
      </if>

    </sequential>
  </macrodef>


  <target name="clean-findbugs" depends="init">

    <delete dir="${build.dir}/findbugs" quiet="true"/>
    <var name="findbugs.output" unset="true"/>

  </target>

  
  <!--
    *************************************************************************************************
    * Development Environment                                                                       *
    *************************************************************************************************
  -->

  <target name="create-dev-eclipse" depends="build-repository">

    <property name="dev.eclipse.dir" value="${root.dir}/dev-eclipse"/>
    <install-eclipse dest="${dev.eclipse.dir}" extensions="${iu.sapphire.dev.env}"/>

  </target>


  <target name="create-dev-target" depends="build-repository">

    <property name="dev.target.dir" value="${root.dir}/dev-target"/>
    
    <if>
      <isset property="iu.sapphire.dev.target.${configuration.recommended}"/>
      <then>
        <propertycopy property=".extensions" from="iu.sapphire.dev.target.${configuration.recommended}" override="true"/>
      </then>
      <else>
        <var name=".extensions" value="${iu.sapphire.dev.target}"/>
      </else>
    </if>
    
    <install-eclipse dest="${dev.target.dir}" extensions="${.extensions}"/>

    <var name=".extensions" unset="true"/>

  </target>


  <target name="clean-start" depends="clean,create-dev-eclipse,create-dev-target,prune-downloads-from-eclipse">
  </target>



  <!--
    *************************************************************************************************
    * Stats                                                                                         *
    *************************************************************************************************
  -->

  <target name="stats" depends="init">

    <property name="root" value="plugins"/>
    <property name="line.count" value="0"/>

    <for param="project.folder">
      <path>
        <dirset dir="${root}">
          <include name="*"/> <!-- not recursive -->
          <exclude name=".metadata"/>
        </dirset>
      </path>
      <sequential>

        <var name="line.count.project" value="0"/>

        <for param="file">
          <path>
            <fileset dir="@{project.folder}">
              <exclude name="bin/**"/>
              <exclude name="build/**"/>
              <exclude name=".javacc/**"/>
              <exclude name=".resources/**"/>
              <exclude name=".apt_generated/**"/>
              <exclude name="**/*.zip"/>
              <exclude name="**/*.jar"/>
              <exclude name="**/*.png"/>
              <exclude name="**/*.gif"/>
              <exclude name="**/*.jpeg"/>
              <exclude name="**/*.jpg"/>
              <exclude name="zipcodes/**"/>
            </fileset>
          </path>
          <sequential>
            <var name="line.count.file" unset="true"/>
            <resourcecount property="line.count.file">
              <tokens>
                <file file="@{file}"/>
              </tokens>
            </resourcecount>
            <!-- <echo message="@{file} : ${line.count.file}"/> -->
            <increment property="line.count.project" amount="${line.count.file}"/>
            <var name="line.count.file" unset="true"/>
          </sequential>
        </for>

        <basename property="project.name" file="@{project.folder}"/>

        <echo message="${project.name}: ${line.count.project}"/>

        <increment property="line.count" amount="${line.count.project}"/>
        <var name="line.count.project" unset="true"/>
        <var name="project.name" unset="true"/>

      </sequential>
    </for>

    <echo message="Overall: ${line.count}"/>

  </target>

  <macrodef name="increment">
    <attribute name="property"/>
    <attribute name="amount"/>
    <sequential>

      <propertycopy name=".temp" from="@{property}" override="true"/>
      <var name="@{property}" unset="true"/>
      <math result="@{property}" operation="+" operand1="${.temp}" operand2="@{amount}" datatype="long"/>
      <var name=".temp" unset="true"/>

    </sequential>
  </macrodef>



  <!--
    *************************************************************************************************
    * Hudson                                                                                        *
    *************************************************************************************************
  -->

  <target name="hudson-build" depends="clean,build,build-alt-configurations,run-tests,findbugs,prune-downloads-from-eclipse">
    
    <echo file="${build.dir}/version.txt">${sapphire.version}</echo>
    
  </target>



  <!--
    *************************************************************************************************
    * Cleanup                                                                                       *
    *************************************************************************************************
  -->

  <target name="clean" depends="clean-bootstrap,clean-repository,clean-target-platforms">
    
    <delete dir="${build.dir}"/>

  </target>


  <target name="clean-bootstrap" depends="init">

    <delete dir="${build.dir}/bootstrap" quiet="true"/>
    <var name="bootstrap.platform" unset="true"/>

  </target>


  <target name="clean-repository" depends="init">

    <delete dir="${build.dir}/repository" quiet="true"/>
    <var name="build.repository.completed" unset="true"/>

  </target>


  <target name="clean-target-platforms" depends="init">

    <for-each-configuration>
      <delete dir="${build.dir}/target-@{configuration}" quiet="true"/>
      <var name="target-@{configuration}" unset="true"/>
    </for-each-configuration>

  </target>



  <!--
    *************************************************************************************************
    * Target Platform                                                                               *
    *************************************************************************************************
  -->


  <macrodef name="create-target-platform">
    <attribute name="configuration"/>
    <sequential>

      <if>
        <not><isset property="target-@{configuration}"/></not>
        <then>

          <property name="target-@{configuration}" value="${build.dir}/target-@{configuration}"/>

          <if>
            <not><available file="${build.dir}/target-@{configuration}"/></not>
            <then>
              <install-eclipse dest="${build.dir}/target-@{configuration}" configuration="@{configuration}" extensions="${iu.sapphire.build.target}"/>
            </then>
          </if>

        </then>
      </if>

    </sequential>
  </macrodef>


  <macrodef name="with-target-platform">
    <attribute name="configuration"/>
    <element name="body" implicit="yes"/>
    <sequential>

      <create-target-platform configuration="@{configuration}"/>
      <propertycopy property=".target.platform" from="target-@{configuration}" override="true"/>
      <body/>
      <var name=".target.platform" unset="true"/>

    </sequential>
  </macrodef>




  <!--
    *************************************************************************************************
    * Configuration and Repository Macros                                                           *
    *************************************************************************************************
  -->

  <macrodef name="load-configuration">
    <attribute name="name"/>
    <sequential>

      <if>
        <not><isset property="repositories.@{name}"/></not>
        <then>

          <echo message="Loading configuration @{name}..."/>

          <property file="${releng.dir}/repositories-@{name}.properties" prefix="."/>

          <var name="eclipse.platform.build.@{name}" value="${.eclipse.platform.build}"/>

          <if>
            <isset property=".p2.repositories"/>
            <then>
              <for list="${.p2.repositories}" param="repo">
                <sequential>
                  <if>
                    <matches pattern="http.*" string="@{repo}"/>
                    <then>
                      <load-repository url="@{repo}" property="repositories.@{name}"/>
                    </then>
                    <else>
                      <with-download-from-eclipse file="@{repo}">
                        <load-repository-archive file="${.download}" property="repositories.@{name}"/>
                      </with-download-from-eclipse>
                    </else>
                  </if>
                </sequential>
              </for>
            </then>
          </if>

          <if>
            <isset property=".legacy.packages"/>
            <then>
              <for list="${.legacy.packages}" param="repo">
                <sequential>
                  <echo message="@{repo}"/>
                  <with-download-from-eclipse file="@{repo}">
                    <load-repository-legacy file="${.download}" property="repositories.@{name}"/>
                  </with-download-from-eclipse>
                </sequential>
              </for>
            </then>
          </if>

          <var name=".eclipse.platform.build" unset="true"/>
          <var name=".p2.repositories" unset="true"/>
          <var name=".legacy.packages" unset="true"/>

        </then>
      </if>

    </sequential>
  </macrodef>


  <macrodef name="with-configuration">
    <attribute name="name"/>
    <element name="body" implicit="yes"/>
    <sequential>

      <load-configuration name="@{name}"/>
      <propertycopy property=".eclipse.platform.build" from="eclipse.platform.build.@{name}" override="true"/>
      <propertycopy property=".repositories" from="repositories.@{name}" override="true"/>
      <body/>
      <var name=".eclipse.platform.build" unset="true"/>
      <var name=".repositories" unset="true"/>

    </sequential>
  </macrodef>


  <macrodef name="for-each-configuration">
    <element name="body" implicit="yes"/>
    <sequential>

      <for list="${configurations}" param="configuration">
        <sequential>
          <var name=".configuration" value="@{configuration}"/>
          <body/>
          <var name=".configuration" unset="true"/>
        </sequential>
      </for>

    </sequential>
  </macrodef>


  <macrodef name="init-download-from-eclipse">
    <sequential>
    
      <!-- Set "downloads" property or SAPPHIRE_DOWNLOADS environment variable to share downloads folder. -->
         
      <if>
        <not><isset property="downloads"/></not>
        <then>
          <if>
            <isset property="env.SAPPHIRE_DOWNLOADS"/>
            <then>
              <var name="downloads" value="${env.SAPPHIRE_DOWNLOADS}"/>
            </then>
            <else>
              <var name="downloads" value="${basedir}/downloads"/>
            </else>
          </if>
        </then>
      </if>
      
      <!-- Set "ignore.checksum.issues" property or SAPPHIRE_IGNORE_CHECKSUM_ISSUES environment variable to 
           not fail build if eclipse.org download fails checksum verification. -->
         
      <if>
        <not><isset property="ignore.checksum.issues"/></not>
        <then>
          <if>
            <isset property="env.SAPPHIRE_IGNORE_CHECKSUM_ISSUES"/>
            <then>
              <var name="ignore.checksum.issues" value="${env.SAPPHIRE_IGNORE_CHECKSUM_ISSUES}"/>
            </then>
            <else>
              <var name="ignore.checksum.issues" value="false"/>
            </else>
          </if>
        </then>
      </if>
      
      <!-- Lookup the set of downloads with known checksum issues that should be ignored. -->
      
      <if>
        <not><isset property="ignore.checksum.issues.list"/></not>
        <then>
          <loadfile srcfile="${basedir}/releng/ignore-checksum-issues.txt" property="ignore.checksum.issues.list"/>
        </then>
      </if>

    </sequential>
  </macrodef>


  <macrodef name="download-from-eclipse">
    <attribute name="file"/>
    <attribute name="property"/>
    <sequential>
    
      <init-download-from-eclipse/>
      
      <mkdir dir="${downloads}"/>
      
      <echo message="Downloading from Eclipse... @{file}"/>

      <echo message="@{file}" file="${downloads}/url-checksum.txt"/>
      <checksum file="${downloads}/url-checksum.txt" property=".url.checksum"/>
      <delete file="${downloads}/url-checksum.txt"/>
      
      <echo message="URL checksum... ${.url.checksum}"/>
      
      <var name=".content.valid" value="false"/>
      
      <for list="1,2,3,4,5" param="counter">
        <sequential>
          <if>
            <not><istrue value="${.content.valid}"/></not>
            <then>

              <if>
                <available file="${downloads}/${.url.checksum}"/>
                <then>
                
                  <!-- Download the expected checksum. -->
                  
                  <get src="http://www.eclipse.org/downloads/sums.php?file=@{file}&amp;type=md5" dest="${downloads}/content-checksum.txt"/>
                  <loadfile srcfile="${downloads}/content-checksum.txt" property=".content.checksum"/>
                  <delete file="${downloads}/content-checksum.txt"/>
                  <propertyregex property=".content.checksum" override="true" input="${.content.checksum}" regexp="([^ ]*).*" select="\1"/>
                  
                  <!-- Verify the local file againsted the expected checksum. -->
                  
                  <checksum file="${downloads}/${.url.checksum}" property=".content.checksum.actual"/>
                      
                  <if>
                    <equals arg1="${.content.checksum}" arg2="${.content.checksum.actual}"/>
                    <then>
                      <var name=".content.valid" value="true"/>
                    </then>
                    <else>
                      <echo message="Checksums did not match. Expected ${.content.checksum}. Got ${.content.checksum.actual}."/>
                      <if>
                        <or>
                          <istrue value="${ignore.checksum.issues}"/>
                          <contains string="${ignore.checksum.issues.list}" substring="@{file}"/>
                        </or>
                        <then>
                          <var name=".content.valid" value="true"/>
                        </then>
                      </if>
                    </else>
                  </if>
                  
                  <var name=".content.checksum" unset="true"/>
                  <var name=".content.checksum.actual" unset="true"/>
                  
                </then>
              </if>

              <if>
                <not><istrue value="${.content.valid}"/></not>
                <then>
                  <if>
                    <istrue value="${force.eclipse.org}"/>
                    <then>
                      <get src="http://www.eclipse.org/downloads/download.php?file=@{file}&amp;mirror_id=1" dest="${downloads}/${.url.checksum}"/>
                    </then>
                    <else>
                      <get src="http://www.eclipse.org/downloads/download.php?file=@{file}&amp;r=1&amp;protocol=http" dest="${downloads}/${.url.checksum}"/>
                    </else>
                  </if>
                </then>
              </if>
              
            </then>
          </if>
        </sequential>
      </for>
      
      <if>
        <istrue value="${.content.valid}"/>
        <then>
        
          <propertyfile file="${downloads}/${.url.checksum}.properties">
            <entry key="LastUsed" type="date" value="now" pattern="yyyy-MM-dd"/>
          </propertyfile>
        
          <var name="@{property}" value="${downloads}/${.url.checksum}"/>
          <var name=".url.checksum" unset="true"/>
          <var name=".content.valid" unset="true"/>
          <var name=".file" unset="true"/>
          <var name=".archived" unset="true"/>
          
        </then>
        <else>
          <fail message="Failed to download @{file} from Eclipse Foundation."/>
        </else>
      </if>
      
    </sequential>
  </macrodef>
  
    
  <macrodef name="prune-downloads-from-eclipse">
    <sequential>
    
      <init-download-from-eclipse/>
      
      <if>
        <available file="${downloads}" type="dir"/>
        <then>
        
          <echo message="Removing Eclipse downloads that haven't been used recently..."/>
        
          <for param="dfe.file">
            <path>
              <fileset dir="${downloads}">
                <include name="*"/>
                  <exclude name="*.properties"/>
              </fileset>
            </path>
            <sequential>
          
              <basename file="@{dfe.file}" property=".dfe.file.name"/>
              <property name=".dfe.file.metadata" value="${downloads}/${.dfe.file.name}.properties"/>
            
              <if>
                <available file="${.dfe.file.metadata}"/>
                <then>
                  <property file="${.dfe.file.metadata}" prefix=".dfe.metadata."/>
                </then>
              </if>
              
              <if>
                <isset property=".dfe.metadata.LastUsed"/>
                <then>
                  
                  <if>
                      <scriptcondition language="javascript">
                      <![CDATA[
                          var dateParts = project.getProperty( ".dfe.metadata.LastUsed" ).split( "-" );
                          
                          if( dateParts.length == 3 )
                          {
                              var lastUsed = new Date( dateParts[ 0 ], dateParts[ 1 ] - 1, dateParts[ 2 ] );
                              var today = new Date();
                              
                              if( today.getTime() - lastUsed.getTime() < ( 30 * 24 * 60 * 60 * 1000 ) )
                              {
                                  self.value = false;
                              }
                              else
                              {
                                  self.value = true;
                            }
                          }
                          else
                          {
                              self.value = false;
                          }
                      ]]>
                      </scriptcondition>
                      <then>
                        <delete file="@{dfe.file}"/>
                        <delete file="${.dfe.file.metadata}"/>
                      </then>
                  </if>
                  
                </then>
                <else>
                  <propertyfile file="${.dfe.file.metadata}">
                    <entry key="LastUsed" type="date" value="now" pattern="yyyy-MM-dd"/>
                  </propertyfile>
                </else>
              </if>
              
              <var name=".dfe.file.name" unset="true"/>
              <var name=".dfe.file.metadata" unset="true"/>
              <var name=".dfe.metadata.LastUsed" unset="true"/>
              
            </sequential>
          </for>
          
        </then>
      </if>
      
    </sequential>
  </macrodef>


  <target name="prune-downloads-from-eclipse" depends="init">
  
    <prune-downloads-from-eclipse/>

  </target>

  
  <macrodef name="wipe-download-from-eclipse">
    <attribute name="file"/>
    <sequential>
    
      <init-download-from-eclipse/>
      
      <echo message="@{file}" file="${downloads}/url-checksum.txt"/>
      <checksum file="${downloads}/url-checksum.txt" property=".url.checksum"/>
      <delete file="${downloads}/url-checksum.txt"/>
      
      <delete file="${downloads}/${.url.checksum}"/>
      
    </sequential>
  </macrodef>


  <target name="wipe-download-from-eclipse" depends="init">
  
    <wipe-download-from-eclipse file="${file}"/>

  </target>


  <macrodef name="with-download-from-eclipse">
    <attribute name="file"/>
    <element name="body" implicit="yes"/>
    <sequential>

      <download-from-eclipse file="@{file}" property=".download"/>
      <body/>
      <var name=".download" unset="true"/>

    </sequential>
  </macrodef>
  

  <macrodef name="load-build-repository">
    <attribute name="url"/>
    <sequential>
      <load-repository url="@{url}" property="build.repositories"/>
    </sequential>
  </macrodef>


  <macrodef name="load-repository">
    <attribute name="url"/>
    <attribute name="property"/>
    <sequential>
      <echo message="Loading repository @{url} ..."/>
      <prepend property="@{property}" value="@{url}"/>
    </sequential>
  </macrodef>


  <macrodef name="load-repository-archive">
    <attribute name="file"/>
    <attribute name="property"/>
    <sequential>
      <load-repository url="jar:file:@{file}!/" property="@{property}"/>
    </sequential>
  </macrodef>


  <macrodef name="load-repository-legacy">
    <attribute name="file"/>
    <attribute name="property"/>
    <sequential>

      <if>
        <not><available file="@{file}.repo"/></not>
        <then>

          <unzip src="@{file}" dest="@{file}.repo">
            <mapper type="regexp" from="^eclipse/(.*)$$" to="\1"/>
          </unzip>

          <delete includeemptydirs="true">
            <fileset dir="@{file}.repo">
              <exclude name="plugins/**"/>
              <exclude name="features/**"/>
            </fileset>
          </delete>

          <p2.publish.FeaturesAndBundles location="@{file}.repo"/>

          <delete includeemptydirs="true">
            <fileset dir="@{file}.repo">
              <exclude name="*.jar"/>
              <exclude name="plugins/*.jar"/>
              <exclude name="features/*.jar"/>
            </fileset>
          </delete>

        </then>
      </if>

      <load-repository url="file:@{file}.repo" property="@{property}"/>

    </sequential>
  </macrodef>


  <macrodef name="install-eclipse">
    <attribute name="dest"/>
    <attribute name="configuration" default="${configuration.recommended}"/>
    <attribute name="platform" default="${current.platform}"/>
    <attribute name="extensions" default=""/>
    <sequential>

      <delete dir="@{dest}" quiet="true"/>
      <mkdir dir="@{dest}"/>

      <with-configuration name="@{configuration}">
        <if>
          <contains string="@{platform}" substring="win32"/>
          <then>
            <var name=".format" value="zip"/>
          </then>
          <else>
            <var name=".format" value="tar.gz"/>
          </else>
        </if>
        <with-download-from-eclipse file="${.eclipse.platform.build}-@{platform}.${.format}">
          <if>
            <equals arg1="${.format}" arg2="zip"/>
            <then>
              <unzip src="${.download}" dest="@{dest}">
                <mapper type="regexp" from="^eclipse/(.*)$$" to="\1"/>
              </unzip>
            </then>
            <else>
              <delete file="${.download}.tar" quiet="true"/>
              <gunzip src="${.download}" dest="${.download}.tar"/>
              <untar src="${.download}.tar" dest="@{dest}">
                <mapper type="regexp" from="^eclipse/(.*)$$" to="\1"/>
              </untar>
              <delete file="${.download}.tar"/>
            </else>
          </if>
        </with-download-from-eclipse>
        <var name=".format" unset="true"/>
      </with-configuration>

      <if>
        <not><equals arg1="@{extensions}" arg2=""/></not>
        <then>
          <install-extensions dest="@{dest}" configuration="@{configuration}" extensions="@{extensions}"/>
        </then>
      </if>

      <adjust-eclipse-ini install="@{dest}" platform="@{platform}"/>

    </sequential>
  </macrodef>


  <macrodef name="install-extensions">
    <attribute name="dest"/>
    <attribute name="configuration" default="${configuration.recommended}"/>
    <attribute name="extensions"/>
    <sequential>
      <with-configuration name="@{configuration}">
        <if>
          <isset property="build.repositories"/>
          <then>
            <append property=".repositories" value="${build.repositories}"/>
          </then>
        </if>
        <java classname="org.eclipse.core.launcher.Main" fork="true" failonerror="true">
          <classpath>
            <fileset dir="${bootstrap.platform}/plugins">
              <include name="**/org.eclipse.equinox.launcher_*.jar"/>
            </fileset>
          </classpath>
          <arg line="-application org.eclipse.equinox.p2.director"/>
          <arg line="-metadataRepository ${.repositories}"/>
          <arg line="-artifactRepository ${.repositories}"/>
          <arg line="-destination @{dest}"/>
          <arg line="-installIU @{extensions}"/>
          <arg line="-vmargs"/>
          <arg line="-Declipse.p2.data.area=@{dest}/p2"/>
          <jvmarg line="-Xmx512m"/>
        </java>
      </with-configuration>
    </sequential>
  </macrodef>


  <macrodef name="adjust-eclipse-ini">
    <attribute name="install"/>
    <attribute name="platform"/>
    <sequential>
      <var name=".eclipse.ini" value="@{install}/eclipse.ini"/>
      <if>
        <not><available file="${.eclipse.ini}"/></not>
        <then>
          <var name=".eclipse.ini" value="@{install}/Eclipse.app/Contents/MacOS/eclipse.ini"/>
        </then>
      </if>
      <if>
        <available file="${.eclipse.ini}"/>
        <then>
          <if>
            <contains string="@{platform}" substring="win32"/>
            <then>
              <var name=".nl" value="&#13;&#10;"/>
            </then>
            <else>
              <var name=".nl" value="&#10;"/>
            </else>
          </if>
          <if>
            <contains string="@{platform}" substring="x86_64"/>
            <then>
              <replaceregexp file="${.eclipse.ini}" match="([\n|\r]*)-Xmx[0-9]*m" replace="\1-Xmx1024m\1-XX:MaxPermSize=512m${.nl}-Djava.net.preferIPv4Stack=true"/>
            </then>
            <else>
              <replaceregexp file="${.eclipse.ini}" match="([\n|\r]*)-Xmx[0-9]*m" replace="\1-Xmx512m\1-XX:MaxPermSize=256m${.nl}-Djava.net.preferIPv4Stack=true"/>
            </else>
          </if>
          <replaceregexp file="${.eclipse.ini}" match="[\n|\r]*--launcher.XXMaxPermSize[\n|\r]*[0-9]*m" replace=""/>
          <var name=".eclipse.ini" unset="true"/>
          <var name=".nl" unset="true"/>
        </then>
        <else>
          <fail message="Could not locate eclipse.ini file in @{install}"/>
        </else>
      </if>
    </sequential>
  </macrodef>


</project>
